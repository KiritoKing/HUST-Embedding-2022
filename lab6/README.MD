# Lab 6： JPEG Picture Viewer

实验6实现原理详述，**注意本程序只支持JPG**

## 功能实现

功能函数全部存储在`utils.c`中

### 图像显示相关

- `pos_image`是`fb_image`的包装类型，包含了图片的窗口位置（左上角坐标）和缩放信息
- `init_image`和`free_image`是包装类的构造和析构函数
- `move_image`负责移动视窗，移动时会检测图像边界与视窗边界的碰撞
- `display_image`负责根据视窗截取当前屏幕大小的图像进行显示
- `zoom_image`通过**最临近插值法**根据输入的scale生成缩放后的图像后存储在`pos_image->tmp`中（若`tmp`存在则其他函数优先使用`tmp`的数据），并根据比例移动视窗
- `fit_screen`根据图像初始大小缩放图片以适应屏幕

### 多文件相关

程序通过维持全局变量`pic_list`, `now`, `total`来进行多文件操作，每次切换文件都会更新now的值，并根据`pic_list[now]`重新读取图像进行渲染（释放之前的图像）

### 触控相关

参考了lab4中代码，进行了大量修改。

- 不再响应大量产生的`MOVE`事件，而是使用`PRESS`和`RELEASE`事件来判断手指动作，避免了刷新造成的闪烁
- 通过`get_single_event`和`get_pinch_event`两个函数分别解析单指滑动和双指捏合两种动作类型
  - 定义了`TOUCH_EVENT`枚举类型来说明触摸事件类型
  - `get_single_event`通过滑动的起点和终点在水平和垂直方向上的距离是否超过阈值来判定事件类型
  - `get_pinch_event`通过两个触点在按下和抬起时的距离变化来判断捏合还是松开
- 通过双重锁机制实现多点触控的判定
  - 通过`lock`变量存储已经按下的手指数，在大于阈值时停止响应触控事件
  - 通过`pinch_mode`变量判断模式，在手指数为2时开启双指模式并在全部抬起后计算双指动作类型后关闭双指模式**（注意：这里有一个框架产生的BUG，两个手指同时抬起只能收到一个`RELEASE`事件）**

## 其他

- test.c：命令行测试函数，可以不管
- 只支持读取`./out`根目录下的JPG图片